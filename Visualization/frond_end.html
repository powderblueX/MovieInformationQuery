<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Database Query Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .query-section {
            margin-bottom: 40px;
        }
        .query-group {
            margin-top: 10px;
        }
        select, button, input {
            padding: 10px;
            margin-right: 10px;
            font-size: 16px;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        .results pre {
            margin: 0;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Movie Database Query Interface</h1>

    <!-- 按时间查询 -->
    <div class="query-section">
        <h2>1. 按时间查询</h2>
        <div class="query-group">
            <label for="time-query">选择查询类型：</label>
            <select id="time-query">
                <option value="year">某年有多少电影</option>
                <option value="month">某年某月有多少电影</option>
                <option value="quarter">某年某季度有多少电影</option>
                <option value="weekday">2004.1.20(周二)新增多少电影</option>
            </select>
            <input type="number" id="year" placeholder="年份 (如2020)">
            <input type="number" id="month" placeholder="月份 (1~12)">
            <input type="number" id="quarter" placeholder="季度 (1~4)">
            <button onclick="runQuery('time')">查询</button>
        </div>
    </div>

    <!-- 按电影名称查询 -->
    <div class="query-section">
        <h2>2. 按电影名称查询</h2>
        <div class="query-group">
            <label for="movie-title">电影名称：</label>
            <input type="text" id="movie-title" placeholder="如：Marvel's The Avengers">
            <button onclick="runQuery('title')">查询</button>
        </div>
    </div>

    <!-- 按导演查询 -->
    <div class="query-section">
        <h2>3. 按导演查询</h2>
        <div class="query-group">
            <label for="director-name">导演名称：</label>
            <input type="text" id="director-name" placeholder="如：Christopher Nolan">
            <button onclick="runQuery('director')">查询</button>
        </div>
    </div>

    <!-- 按演员查询 -->
    <div class="query-section">
        <h2>4. 按演员查询</h2>
        <div class="query-group">
            <label for="actor-query">选择查询类型：</label>
            <select id="actor-query">
                <option value="star">主演多少电影</option>
                <option value="act">参演多少电影</option>
            </select>
            <input type="text" id="actor-name" placeholder="演员名称 (如：Andrew Garfield)">
            <button onclick="runQuery('actor')">查询</button>
        </div>
    </div>

    <!-- 按类别查询 -->
    <div class="query-section">
        <h2>5. 按类别查询</h2>
        <div class="query-group">
            <label for="genre">电影类别：</label>
            <input type="text" id="genre" placeholder="如：Action">
            <button onclick="runQuery('genre')">查询</button>
        </div>
    </div>

    <!-- 按评分查询 -->
    <div class="query-section">
        <h2>6. 按评分查询</h2>
        <div class="query-group">
            <label for="rating-query">选择查询类型：</label>
            <select id="rating-query">
                <option value="score-above">评分大于X的电影</option>
                <option value="positive">有正面评价的电影</option>
            </select>
            <input type="number" id="score" placeholder="评分 (如：3)">
            <button onclick="runQuery('rating')">查询</button>
        </div>
    </div>

    <!-- 按关系查询 -->
    <div class="query-section">
        <h2>7. 按关系查询</h2>
        <div class="query-group">
            <label for="relationship">选择关系：</label>
            <select id="relationship">
                <option value="actors">经常合作的演员</option>
                <option value="directors">经常合作的导演和演员</option>
                <option value="pair">最受关注的演员组合</option>
            </select>
            <button onclick="runQuery('relation')">查询</button>
        </div>
    </div>

    <!-- 查询结果展示 -->
    <div class="results" id="results">
        <h3>查询结果：</h3>
        <pre id="query-output">暂无结果</pre>
    </div>
</div>

<script>
    async function runQuery(type) {
        const output = document.getElementById('query-output');
        let query = '';
        // 获取开始时间
        const startTime = performance.now();
        try {
            switch (type) {
                case 'time':
                    const timeType = document.getElementById('time-query').value;
                    const year = document.getElementById('year').value || '2020';
                    const month = document.getElementById('month').value || '1';
                    const quarter = document.getElementById('quarter').value || '1';
                    if (timeType === 'year') {
                        query = `MATCH (m:Movies) WHERE m.Year = ${year} RETURN count(m) AS movies_in_${year}`;
                    } else if (timeType === 'month') {
                        query = `MATCH (m:Movies) WHERE m.Year = ${year} AND m.Month = ${month} RETURN count(m) AS movies_in_${year}_${month}`;
                    } else if (timeType === 'quarter') {
                        const startMonth = 1 + (quarter - 1) * 3;
                        const endMonth = startMonth + 2;
                        query = `MATCH (m:Movies) WHERE m.Year = ${year} AND m.Month >= ${startMonth} AND m.Month <= ${endMonth} RETURN count(m) AS movies_in_q${quarter}_${year}`;
                    } else if (timeType === 'weekday') {
                        query = `MATCH (m:Movies) WHERE m.Year = 2004 AND m.Month = 1 AND m.Day = 20 RETURN count(m) AS movies_on_tuesday_1_20_2004`;
                    }
                    break;
                case 'title':
                    const title = document.getElementById('movie-title').value;
                    query = `MATCH (m:Movies)-[:HAS_FORMAT]->(f:Formats) WHERE m.Movie_Title = "${title}" RETURN count(DISTINCT f) AS versions_of_Movie`;
                    break;
                case 'director':
                    const director = document.getElementById('director-name').value;
                    query = `MATCH (d:Directors)-[:DIRECT]->(m:Movies) WHERE d.Director_Name = "${director}" RETURN count(m) AS movies_directed_by_${director.last}`;
                    break;
                case 'actor':
                    const actorType = document.getElementById('actor-query').value;
                    const actorName = document.getElementById('actor-name').value;
                    if (actorType === 'star') {
                        query = `MATCH (a:Actors)-[:STAR]->(m:Movies) WHERE a.Actor_Name = "${actorName}" RETURN count(DISTINCT m) AS movies_stared_by_${actorName.last}`;
                    } else if (actorType === 'act') {
                        query = `MATCH (a:Actors)-[:ACT]->(m:Movies) WHERE a.Actor_Name = "${actorName}" RETURN count(DISTINCT m) AS movies_acted_by_${actorName.last}`;
                    }
                    break;
                case 'genre':
                    const genre = document.getElementById('genre').value;
                    query = `MATCH (m:Movies)-[:HAS_GENRE]->(g:Genres) WHERE g.Genre = "${genre}" RETURN count(m) AS ${genre}_movies_count`;
                    break;
                case 'rating':
                    const ratingType = document.getElementById('rating-query').value;
                    const score = document.getElementById('score').value || '3';
                    if (ratingType === 'score-above') {
                        query = `MATCH (m:Movies) WHERE m.Average_Score > ${score} RETURN count(*)`;
                    } else if (ratingType === 'positive') {
                        query = `MATCH (m:Movies)-[:HAS_REVIEW]->(r:Reviews) WHERE r.Score = 5 RETURN DISTINCT m.Movie_Title AS positive_review_movies`;
                    }
                    break;
                case 'relation':
                    const relation = document.getElementById('relationship').value;
                    if (relation === 'actors') {
                        query = `MATCH (a1:Actors)-[r:COOPERATED]-(a2:Actors) WHERE r.count > 20 RETURN a1.Actor_Name, a2.Actor_Name, r.count ORDER BY r.count DESC LIMIT 1;`;
                    } else if (relation === 'directors') {
                        query = `MATCH (a:Actors)-[r:COOPERATED_WITH_DIRECTOR]->(d:Directors) WHERE r.count > 20 RETURN a.Actor_Name AS Actor, d.Director_Name AS Director, r.count AS Collaborations ORDER BY r.count DESC LIMIT 2;`;
                    } else if (relation === 'pair') {
                        query = `MATCH (m:Movies)-[:HAS_GENRE]->(g:Genres) WHERE g.Genre = 'Action' WITH m MATCH (a1:Actors)-[:ACT]->(m)<-[:ACT]-(a2:Actors) WHERE a1.Actor_ID < a2.Actor_ID WITH a1, a2, sum(m.Reviews_Count) AS total_reviews RETURN a1.Actor_Name AS Actor1, a2.Actor_Name AS Actor2, total_reviews ORDER BY total_reviews DESC LIMIT 1;`;
                    }
                    break;
            }
            output.textContent = query || '请输入有效数据！';
            // 发送查询请求到后端

            // 请求后端执行查询
            const response = await fetch('http://localhost:3000/query', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query}),
            });

            const result = await response.json();

            // 获取结束时间
            const endTime = performance.now();
            const timeElapsed = (endTime - startTime).toFixed(2); // 保留两位小数

            if (result.success) {
                if (document.getElementById('relationship').value === "directors") {
                    output.textContent = `查询结果:\n${JSON.stringify(result.data[1], null, 2)}\n查询耗时: ${timeElapsed} ms`;
                } else {
                    output.textContent = `查询结果:\n${JSON.stringify(result.data, null, 2)}\n查询耗时: ${timeElapsed} ms`;
                }
            } else {
                output.textContent = `查询失败: ${result.error}`;
            }
        } catch (error) {
            output.textContent = `请求失败: ${error.message}`;
        }
    }
</script>
</body>
</html>
